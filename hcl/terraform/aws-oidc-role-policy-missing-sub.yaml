rules:
  - id: aws-oidc-role-policy-missing-sub
    message: |
      Found AWS role policy for GitHub Actions missing OIDC subject. This
      means any GitHub repository can assume this role in CI.
    languages: [hcl]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-284: Improper Access Control"
      subcategory: [audit]
      confidence: HIGH
      likelihood: HIGH
      impact: HIGH
      technology: [terraform, aws]
      references:
        - https://securitylabs.datadoghq.com/articles/exploring-github-to-aws-keyless-authentication-flaws/
        - https://www.rezonate.io/blog/github-misconfigurations-put-gcp-aws-in-account-takeover-risk
        - https://github.com/Rezonate-io/github-oidc-checker/
    patterns:
      - pattern-inside: |
          {
            ...
            Statement = [...]
            ...
          }
      - pattern-inside: |
          {
            ...,
            "Action": "sts:AssumeRoleWithWebIdentity",
            ...
          }
      - pattern: |
          {
            ...
            "Condition": {
                ...
                "StringEquals": {
                    ...
                    "token.actions.githubusercontent.com:aud": ...,
                    ...
                }
                ...
            }
            ...
          }
      - pattern-not: |
          {
            ...
            "Condition": {
                ...
                "StringEquals": {
                    ...
                    "token.actions.githubusercontent.com:sub": ...,
                    ...
                    "token.actions.githubusercontent.com:aud": ...,
                    ...
                }
                ...
            }
            ...
          }
      - pattern-not: |
          {
            ...
            "Condition": {
                ...
                "StringEquals": {
                    ...
                    "token.actions.githubusercontent.com:aud": ...,
                    ...
                    "token.actions.githubusercontent.com:sub": ...,
                    ...
                }
                ...
            }
            ...
          }
      - pattern-not: |
          {
            ...
            "Condition": {
                ...
                "StringLike": {
                    ...
                    "token.actions.githubusercontent.com:sub": ...,
                    ...
                }
                ...
                "StringEquals": {
                    ...
                    "token.actions.githubusercontent.com:aud": ...,
                    ...
                }
                ...
            }
            ...
          }
      - pattern-not: |
          {
            ...
            "Condition": {
                ...
                "StringEquals": {
                    ...
                    "token.actions.githubusercontent.com:aud": ...,
                    ...
                }
                ...
                "StringLike": {
                    ...
                    "token.actions.githubusercontent.com:sub": ...,
                    ...
                }
                ...
            }
            ...
          }
